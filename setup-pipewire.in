#!/bin/sh

if [ $(id -u) -ne 0 ]; then
   echo "this script must be run as root"
   exit 1
fi

#########################################################################################
# PROGRAM METADATA
#########################################################################################

PROGRAM=$(basename "$0")
PROGRAM_DIR=@PROGRAM_DIR@
VERSION=@VERSION@

#########################################################################################
# PROGRAM DEPENDENCIES
#########################################################################################

. "@LIB_DIR@/libusralpine.sh"

#########################################################################################
# PREREQUISITES 
#########################################################################################

echo
task "1. setup-dbus"
task "2. setup-pipewire"

"$PROGRAM_DIR/setup-dbus" || die "pipeware setup - failed to install prerequisite: dbus" 

#########################################################################################
# PROGRAM 
#########################################################################################

header "$PROGRAM"


step "adding pipewire"
apk add pipewire pipewire-alsa pipewire-pulse wireplumber || die "pipeware setup - failed to install pipewire" 

step "adding root to audio group"
addgroup root audio

step "adding $DOAS_USER to audio group"
addgroup "$DOAS_USER" audio

step "restarting dbus service"
rc-service dbus restart || warn "pipewire setup - failed to restart dbus service. please restart manually."

footer_start
footer_text "start pipewire with /usr/libexec/pipewire-launcher"
footer_text "if you are using swaywm then start sway with"
footer_text "'dbus-launch --exit-with-session sway' or"
footer_text "'dbus-launch --exit-with-session seatd-launch sway' when using"
footer_text "seatd with seatd launch"
footer_end